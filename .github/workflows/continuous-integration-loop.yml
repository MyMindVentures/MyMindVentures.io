name: Continuous Integration Loop

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
        - development
        - staging
        - production
      force_rebuild:
        description: 'Force complete rebuild'
        required: false
        default: false
        type: boolean
      skip_tests:
        description: 'Skip tests (not recommended)'
        required: false
        default: false
        type: boolean

  # Automatic triggers
  push:
    branches: [main, develop, feature/*, hotfix/*]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8'

jobs:
  # 1. PREPARATION & VALIDATION
  preparation:
    name: ğŸš€ Preparation & Validation
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.decision.outputs.should_deploy }}
      environment: ${{ steps.decision.outputs.environment }}
      force_rebuild: ${{ steps.decision.outputs.force_rebuild }}
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ” Analyze commit and determine action
        id: decision
        run: |
          echo "Analyzing commit: ${{ github.event.head_commit.message }}"
          
          # Determine environment
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ENVIRONMENT="${{ github.event.inputs.environment }}"
            FORCE_REBUILD="${{ github.event.inputs.force_rebuild }}"
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            ENVIRONMENT="production"
            FORCE_REBUILD="false"
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            ENVIRONMENT="staging"
            FORCE_REBUILD="false"
          else
            ENVIRONMENT="development"
            FORCE_REBUILD="false"
          fi
          
          # Determine if we should deploy
          SHOULD_DEPLOY="false"
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]] || [[ "${{ github.ref }}" == "refs/heads/main" ]] || [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            SHOULD_DEPLOY="true"
          fi
          
          echo "should_deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT
          echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
          echo "force_rebuild=$FORCE_REBUILD" >> $GITHUB_OUTPUT
          
          echo "ğŸš€ Decision made:"
          echo "  - Environment: $ENVIRONMENT"
          echo "  - Should deploy: $SHOULD_DEPLOY"
          echo "  - Force rebuild: $FORCE_REBUILD"

      - name: ğŸ“Š Generate workflow summary
        run: |
          echo "## ğŸ”„ Continuous Integration Loop Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ steps.decision.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deploy:** ${{ steps.decision.outputs.should_deploy }}" >> $GITHUB_STEP_SUMMARY
          echo "**Force Rebuild:** ${{ steps.decision.outputs.force_rebuild }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.decision.outputs.should_deploy }}" == "true" ]]; then
            echo "1. âœ… Code Quality & Security" >> $GITHUB_STEP_SUMMARY
            echo "2. ğŸ§ª Testing & Validation" >> $GITHUB_STEP_SUMMARY
            echo "3. ğŸ—ï¸ Build & Optimization" >> $GITHUB_STEP_SUMMARY
            echo "4. ğŸš€ Deployment" >> $GITHUB_STEP_SUMMARY
            echo "5. ğŸ“Š Post-Deployment Validation" >> $GITHUB_STEP_SUMMARY
          else
            echo "1. âœ… Code Quality & Security" >> $GITHUB_STEP_SUMMARY
            echo "2. ğŸ§ª Testing & Validation" >> $GITHUB_STEP_SUMMARY
            echo "3. ğŸ“Š Results Analysis" >> $GITHUB_STEP_SUMMARY
          fi

  # 2. CODE QUALITY & SECURITY
  code-quality:
    name: âœ… Code Quality & Security
    runs-on: ubuntu-latest
    needs: preparation
    if: always()
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Lint code
        run: npm run lint

      - name: ğŸ”’ Security audit
        run: npm audit --audit-level=moderate

      - name: ğŸ“ Type check
        run: npm run type-check

      - name: ğŸ¨ Format check
        run: npm run format:check

      - name: ğŸ“Š Generate quality report
        run: |
          echo "## âœ… Code Quality & Security Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** âœ… Completed" >> $GITHUB_STEP_SUMMARY
          echo "**Linting:** âœ… Passed" >> $GITHUB_STEP_SUMMARY
          echo "**Security:** âœ… Audited" >> $GITHUB_STEP_SUMMARY
          echo "**Types:** âœ… Validated" >> $GITHUB_STEP_SUMMARY
          echo "**Format:** âœ… Consistent" >> $GITHUB_STEP_SUMMARY

  # 3. TESTING & VALIDATION
  testing:
    name: ğŸ§ª Testing & Validation
    runs-on: ubuntu-latest
    needs: [preparation, code-quality]
    if: always()
    
    strategy:
      matrix:
        node-version: [16, 18, 20]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ§ª Run unit tests
        run: npm run test:unit

      - name: ğŸ”— Run integration tests
        run: npm run test:integration

      - name: ğŸŒ Run E2E tests
        run: npm run test:e2e

      - name: ğŸ“Š Generate coverage report
        run: npm run test:coverage

      - name: ğŸ“Š Generate testing report
        run: |
          echo "## ğŸ§ª Testing & Validation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Node.js Version:** ${{ matrix.node-version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Unit Tests:** âœ… Passed" >> $GITHUB_STEP_SUMMARY
          echo "**Integration Tests:** âœ… Passed" >> $GITHUB_STEP_SUMMARY
          echo "**E2E Tests:** âœ… Passed" >> $GITHUB_STEP_SUMMARY
          echo "**Coverage:** ğŸ“Š Generated" >> $GITHUB_STEP_SUMMARY

  # 4. BUILD & OPTIMIZATION
  build:
    name: ğŸ—ï¸ Build & Optimization
    runs-on: ubuntu-latest
    needs: [preparation, code-quality, testing]
    if: needs.preparation.outputs.should_deploy == 'true' && always()
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build application
        run: npm run build

      - name: ğŸ“Š Analyze bundle
        run: npm run build:analyze

      - name: ğŸš€ Lighthouse CI
        run: npm run lighthouse

      - name: ğŸ“Š Generate build report
        run: |
          echo "## ğŸ—ï¸ Build & Optimization Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** âœ… Completed" >> $GITHUB_STEP_SUMMARY
          echo "**Build:** âœ… Successful" >> $GITHUB_STEP_SUMMARY
          echo "**Bundle Analysis:** ğŸ“Š Generated" >> $GITHUB_STEP_SUMMARY
          echo "**Lighthouse:** ğŸ“Š Performance metrics" >> $GITHUB_STEP_SUMMARY

  # 5. DEPLOYMENT
  deployment:
    name: ğŸš€ Deployment
    runs-on: ubuntu-latest
    needs: [preparation, code-quality, testing, build]
    if: needs.preparation.outputs.should_deploy == 'true' && always()
    environment: ${{ needs.preparation.outputs.environment }}
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build for deployment
        run: npm run build:${{ needs.preparation.outputs.environment }}

      - name: ğŸš€ Deploy to ${{ needs.preparation.outputs.environment }}
        run: |
          echo "Deploying to ${{ needs.preparation.outputs.environment }}..."
          npm run deploy:${{ needs.preparation.outputs.environment }}

      - name: ğŸ§ª Smoke tests
        run: npm run test:smoke:${{ needs.preparation.outputs.environment }}

      - name: ğŸ“Š Generate deployment report
        run: |
          echo "## ğŸš€ Deployment Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.preparation.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** âœ… Deployed" >> $GITHUB_STEP_SUMMARY
          echo "**Smoke Tests:** âœ… Passed" >> $GITHUB_STEP_SUMMARY

  # 6. POST-DEPLOYMENT VALIDATION
  post-deployment:
    name: ğŸ“Š Post-Deployment Validation
    runs-on: ubuntu-latest
    needs: [preparation, deployment]
    if: needs.preparation.outputs.should_deploy == 'true' && always()
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ¥ Health check
        run: npm run health:check:${{ needs.preparation.outputs.environment }}

      - name: ğŸ“Š Performance monitoring
        run: npm run performance:monitor:${{ needs.preparation.outputs.environment }}

      - name: ğŸ” Error monitoring
        run: npm run error:monitor:${{ needs.preparation.outputs.environment }}

      - name: ğŸ“Š Generate validation report
        run: |
          echo "## ğŸ“Š Post-Deployment Validation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Health Check:** âœ… Passed" >> $GITHUB_STEP_SUMMARY
          echo "**Performance:** ğŸ“Š Monitored" >> $GITHUB_STEP_SUMMARY
          echo "**Error Rate:** ğŸ“Š Monitored" >> $GITHUB_STEP_SUMMARY

  # 7. FINAL SUMMARY
  summary:
    name: ğŸ“‹ Final Summary
    runs-on: ubuntu-latest
    needs: [preparation, code-quality, testing, build, deployment, post-deployment]
    if: always()
    
    steps:
      - name: ğŸ“Š Generate final summary
        run: |
          echo "## ğŸ¯ Continuous Integration Loop - Final Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Determine overall status
          if [[ "${{ needs.preparation.outputs.should_deploy }}" == "true" ]]; then
            echo "**ğŸ‰ DEPLOYMENT COMPLETED SUCCESSFULLY!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Environment:** ${{ needs.preparation.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
            echo "**Deployment Time:** $(date)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**âœ… VALIDATION COMPLETED SUCCESSFULLY!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**No deployment required for this branch**" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ğŸ“‹ Job Results:**" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸš€ Preparation: ${{ needs.preparation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Code Quality: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ§ª Testing: ${{ needs.testing.result }}" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.preparation.outputs.should_deploy }}" == "true" ]]; then
            echo "- ğŸ—ï¸ Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸš€ Deployment: ${{ needs.deployment.result }}" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ“Š Post-Deployment: ${{ needs.post-deployment.result }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ğŸ”„ Next Steps:**" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.preparation.outputs.should_deploy }}" == "true" ]]; then
            echo "1. ğŸ‰ Monitor application performance" >> $GITHUB_STEP_SUMMARY
            echo "2. ğŸ“Š Review deployment metrics" >> $GITHUB_STEP_SUMMARY
            echo "3. ğŸ” Address any post-deployment issues" >> $GITHUB_STEP_SUMMARY
          else
            echo "1. ğŸ”„ Continue development on feature branch" >> $GITHUB_STEP_SUMMARY
            echo "2. ğŸ“ Address any code quality issues" >> $GITHUB_STEP_SUMMARY
            echo "3. ğŸ§ª Fix any failing tests" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ¯ Set workflow status
        run: |
          # Determine overall workflow status
          if [[ "${{ needs.preparation.outputs.should_deploy }}" == "true" ]]; then
            if [[ "${{ needs.deployment.result }}" == "success" ]]; then
              echo "ğŸ‰ Workflow completed successfully with deployment!"
              exit 0
            else
              echo "âŒ Workflow failed during deployment!"
              exit 1
            fi
          else
            if [[ "${{ needs.testing.result }}" == "success" ]]; then
              echo "âœ… Workflow completed successfully with validation!"
              exit 0
            else
              echo "âŒ Workflow failed during validation!"
              exit 1
            fi
          fi
